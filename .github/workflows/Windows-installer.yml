name: Build and Package Cura Installer (Windows)

on:
  workflow_dispatch:
    inputs:
      cura_version:
        description: 'Cura Version'
        default: '5.11.0-alpha.0'
        required: true
        type: string
      enterprise:
        description: 'Build Enterprise Edition'
        default: false
        required: false
        type: boolean
      staging:
        description: 'Use Staging API'
        default: false
        required: false
        type: boolean

jobs:
  build-windows:
    runs-on: windows-2022

    env:
      CURA_VERSION: ${{ inputs.cura_version }}
      CONAN_USER_HOME: ${{ github.workspace }}\.conan2

    steps:
    - name: ğŸ§¾ æ£€å‡º Cura æºç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ğŸ å®‰è£… Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: ğŸ›  è®¾ç½® MSVC ç¯å¢ƒ
      uses: microsoft/setup-msbuild@v1.3

    - name: ğŸ›  è®¾ç½® Visual Studio ç¯å¢ƒ
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: ğŸ§ª å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install conan==2.7.0
        pip install sip==6.5.1
        pip install gitpython 

    - name: ğŸ“¦ ç¼“å­˜ Conan åŒ…
      uses: actions/cache@v3
      with:
        path: ~/.conan2
        key: conan-${{ runner.os }}-${{ hashFiles('**/conanfile.py', '**/conandata.yml') }}
        restore-keys: |
          conan-${{ runner.os }}-

    - name: âš™ï¸ é…ç½® Conan
      run: |
        conan config install https://github.com/wsd07/conan-config.git
        conan profile detect --force

    - name: ğŸ” éªŒè¯ Conan é…ç½®
      run: |
        conan profile show
        conan remote list

    - name: ğŸ”ƒ å…‹éš†ä¾èµ–ä»“åº“
      run: |
        git clone https://github.com/wsd07/Uranium.git ../Uranium
        git clone https://github.com/wsd07/CuraEngine.git ../CuraEngine

    - name: ğŸ”— è®¾ç½® editable ä¾èµ–
      run: |
        conan editable add ../Uranium --name=uranium --version=5.11.0 --user=wsd07 --channel=testing
        conan editable add ../CuraEngine --name=curaengine --version=5.11.0 --user=wsd07 --channel=testing

    - name: ğŸ— åˆ›å»º Conan è™šæ‹Ÿç¯å¢ƒ
      run: |
        # ä½¿ç”¨å®˜æ–¹æ–‡æ¡£æ¨èçš„æ–¹æ³•åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
        Write-Host "è¿è¡Œ conan install åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
        conan install . --build=missing --update -g VirtualPythonEnv -v --deployer-package="*" --deployer-folder=.

    - name: âœ… éªŒè¯è™šæ‹Ÿç¯å¢ƒå’Œspecæ–‡ä»¶åˆ›å»º
      run: |
        # æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒè„šæœ¬ (Windowsä½¿ç”¨.batæ–‡ä»¶)
        if (Test-Path "build\generators\virtual_python_env.bat") {
          Write-Host "âœ… è™šæ‹Ÿç¯å¢ƒè„šæœ¬å·²åˆ›å»º"
        } else {
          Write-Host "âŒ è™šæ‹Ÿç¯å¢ƒè„šæœ¬æœªæ‰¾åˆ°"
          Write-Host "build/generators ç›®å½•å†…å®¹ï¼š"
          if (Test-Path "build\generators") {
            Get-ChildItem "build\generators" | ForEach-Object { Write-Host "  - $($_.Name)" }
          } else {
            Write-Host "build/generators ç›®å½•ä¸å­˜åœ¨"
          }
          exit 1
        }

        # æ£€æŸ¥PyInstaller specæ–‡ä»¶æ˜¯å¦å·²ç”Ÿæˆ
        Write-Host "æŸ¥æ‰¾æ‰€æœ‰.specæ–‡ä»¶ï¼š"
        $specFiles = Get-ChildItem -Name "*.spec"
        if ($specFiles) {
          foreach ($file in $specFiles) {
            Write-Host "  æ‰¾åˆ°specæ–‡ä»¶: $file"
          }

          # æ£€æŸ¥æ ‡å‡†çš„UltiMaker-Cura.specæ–‡ä»¶
          if (Test-Path "UltiMaker-Cura.spec") {
            Write-Host "âœ… æ ‡å‡†PyInstaller specæ–‡ä»¶å·²ç”Ÿæˆ"
            $specFile = "UltiMaker-Cura.spec"
          } else {
            # ä½¿ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªspecæ–‡ä»¶
            $specFile = $specFiles[0]
            Write-Host "âš ï¸ ä½¿ç”¨æ‰¾åˆ°çš„specæ–‡ä»¶: $specFile"
          }
        } else {
          Write-Host "âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•PyInstaller specæ–‡ä»¶"
          Write-Host "å°è¯•æ‰‹åŠ¨è¿è¡Œdeployæ–¹æ³•..."

          # å°è¯•æ‰‹åŠ¨è¿è¡Œconan createæ¥è§¦å‘deploy
          try {
            Write-Host "è¿è¡Œ conan create æ¥å¼ºåˆ¶æ‰§è¡Œdeployæ–¹æ³•..."
            conan create . --build=missing -tf=""
          } catch {
            Write-Host "conan create ä¹Ÿå¤±è´¥äº†ï¼Œæ£€æŸ¥é”™è¯¯..."
          }

          # å†æ¬¡æ£€æŸ¥specæ–‡ä»¶
          $specFiles = Get-ChildItem -Name "*.spec"
          if ($specFiles) {
            $specFile = $specFiles[0]
            Write-Host "âœ… é€šè¿‡conan createç”Ÿæˆäº†specæ–‡ä»¶: $specFile"
          } else {
            Write-Host "å½“å‰ç›®å½•å†…å®¹ï¼š"
            Get-ChildItem | ForEach-Object { Write-Host "  - $($_.Name)" }

            # æ£€æŸ¥æ˜¯å¦æœ‰.jinjaæ¨¡æ¿æ–‡ä»¶
            if (Test-Path "UltiMaker-Cura.spec.jinja") {
              Write-Host "âœ… æ‰¾åˆ°Jinjaæ¨¡æ¿æ–‡ä»¶ï¼Œä½†æœªæ¸²æŸ“æˆspecæ–‡ä»¶"
              Write-Host "è¿™å¯èƒ½æ˜¯å› ä¸ºdeploy()æ–¹æ³•ä¸­çš„é”™è¯¯"
            }
            exit 1
          }
        }

        # å°†specæ–‡ä»¶åä¿å­˜åˆ°ç¯å¢ƒå˜é‡ä¸­ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "PYINSTALLER_SPEC_FILE=$specFile" >> $env:GITHUB_ENV

    - name: ğŸ”¨ å®‰è£… NSIS
      run: |
        choco install nsis -y
        $nsisPath = "${env:ProgramFiles(x86)}\NSIS"
        echo "$nsisPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: ğŸ”¨ ä½¿ç”¨ PyInstaller æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        # æ¿€æ´» Conan åˆ›å»ºçš„è™šæ‹Ÿç¯å¢ƒ (Windowsä½¿ç”¨.batæ–‡ä»¶)
        & "build\generators\virtual_python_env.bat"

        # å®‰è£… PyInstaller
        python -m pip install --upgrade pip
        pip install pyinstaller==6.3.0

        # ä½¿ç”¨ä¹‹å‰æ£€æµ‹åˆ°çš„specæ–‡ä»¶
        $specFile = $env:PYINSTALLER_SPEC_FILE
        Write-Host "ä½¿ç”¨PyInstaller specæ–‡ä»¶: $specFile"

        if (Test-Path $specFile) {
          Write-Host "âœ… PyInstaller spec æ–‡ä»¶å­˜åœ¨ï¼Œå‡†å¤‡æ„å»º"

          # æ˜¾ç¤ºspecæ–‡ä»¶çš„å‰å‡ è¡Œä»¥ç¡®è®¤å†…å®¹
          Write-Host "Specæ–‡ä»¶å†…å®¹é¢„è§ˆï¼š"
          Get-Content $specFile | Select-Object -First 5 | ForEach-Object { Write-Host "  $_" }
        } else {
          Write-Host "âŒ PyInstaller spec æ–‡ä»¶ä¸å­˜åœ¨: $specFile"
          exit 1
        }

        # è¿è¡Œ PyInstaller
        Write-Host "å¼€å§‹è¿è¡Œ PyInstaller..."
        pyinstaller $specFile --clean --noconfirm --log-level=INFO

        # éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶ç”Ÿæˆ - åŠ¨æ€æ£€æµ‹å¯æ‰§è¡Œæ–‡ä»¶å
        Write-Host "æ£€æŸ¥distç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶..."
        if (Test-Path "dist") {
          $exeFiles = Get-ChildItem -Recurse "dist" -Name "*.exe"
          if ($exeFiles) {
            Write-Host "æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼š"
            foreach ($exe in $exeFiles) {
              $fullPath = Join-Path "dist" $exe
              $exe_size = (Get-Item $fullPath).Length/1MB
              Write-Host "  - $exe (å¤§å°: $([math]::Round($exe_size, 2)) MB)"
            }
            Write-Host "âœ… å¯æ‰§è¡Œæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          } else {
            Write-Host "âŒ PyInstaller æœªç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶"
            Write-Host "dist ç›®å½•å†…å®¹ï¼š"
            Get-ChildItem -Recurse "dist" | Select-Object -First 20 | ForEach-Object { Write-Host "  - $($_.FullName)" }
            exit 1
          }
        } else {
          Write-Host "âŒ dist ç›®å½•ä¸å­˜åœ¨"

          # æ£€æŸ¥PyInstallerçš„å·¥ä½œç›®å½•
          if (Test-Path "build") {
            Write-Host "build ç›®å½•å†…å®¹ï¼š"
            Get-ChildItem -Recurse "build" | Select-Object -First 10 | ForEach-Object { Write-Host "  - $($_.FullName)" }
          }
          exit 1
        }

    - name: ğŸ“¦ åˆ›å»º Windows å®‰è£…ç¨‹åº
      run: |
        # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
        & "build\generators\virtual_python_env.bat"

        # å®‰è£…å¿…è¦çš„ä¾èµ–
        pip install jinja2 semver

        # æ£€æŸ¥ NSIS è„šæœ¬
        $nsis_script = "packaging\NSIS\create_windows_installer.py"
        if (Test-Path $nsis_script) {
          Write-Host "âœ… NSIS è„šæœ¬å­˜åœ¨: $nsis_script"
        } else {
          Write-Host "âŒ NSIS è„šæœ¬ä¸å­˜åœ¨: $nsis_script"
          Write-Host "packaging ç›®å½•å†…å®¹ï¼š"
          if (Test-Path "packaging") {
            Get-ChildItem -Recurse "packaging" | Select-Object -First 10 | ForEach-Object { Write-Host "  - $($_.FullName)" }
          }
          exit 1
        }

        # æ£€æŸ¥ PyInstaller è¾“å‡º
        if (Test-Path "dist\UltiMaker-Cura") {
          Write-Host "âœ… PyInstaller è¾“å‡ºç›®å½•å­˜åœ¨"
        } else {
          Write-Host "âŒ PyInstaller è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
          exit 1
        }

        # ç”Ÿæˆå®‰è£…ç¨‹åºæ–‡ä»¶å
        $installer_filename = "UltiMaker-Cura-${{ env.CURA_VERSION }}-Windows-x64.exe"
        Write-Host "ç”Ÿæˆå®‰è£…ç¨‹åº: $installer_filename"

        # æ‰§è¡Œ NSIS è„šæœ¬
        python $nsis_script --source_path . --dist_path dist --filename $installer_filename --version ${{ env.CURA_VERSION }}

        # æ£€æŸ¥å®‰è£…ç¨‹åºæ˜¯å¦ç”Ÿæˆ
        if (Test-Path "dist\$installer_filename") {
          $size = (Get-Item "dist\$installer_filename").Length/1MB
          Write-Host "âœ… å®‰è£…ç¨‹åºç”ŸæˆæˆåŠŸ (å¤§å°: $size MB)"
        } else {
          Write-Host "âŒ å®‰è£…ç¨‹åºæœªç”Ÿæˆ"
          Write-Host "dist ç›®å½•å†…å®¹ï¼š"
          Get-ChildItem "dist" | ForEach-Object { Write-Host "  - $($_.Name)" }
          exit 1
        }

    - name: â˜ï¸ ä¸Šä¼ å®‰è£…åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: cura-windows-installer-${{ env.CURA_VERSION }}
        path: dist/UltiMaker-Cura-${{ env.CURA_VERSION }}-Windows-x64.exe
        retention-days: 7
