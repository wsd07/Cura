# åç§°ï¼šåœ¨ GitHub Actions é¡µé¢æ˜¾ç¤ºçš„ä»»åŠ¡åç§°
name: Build and Package Cura Installer (Windows)

# è§¦å‘æ–¹å¼ï¼šæ‰‹åŠ¨è§¦å‘ workflowï¼ˆå¯é€‰ future æ‰©å±• push/tag ç­‰è§¦å‘ï¼‰
on:
  workflow_dispatch:

jobs:
  build-windows:
    # æŒ‡å®šè¿è¡Œå¹³å°ä¸º GitHub æä¾›çš„æœ€æ–° Windows ç³»ç»Ÿï¼ˆWindows Server 2022ï¼‰
    runs-on: windows-latest

    # è®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡
    env:
      CURA_VERSION: 5.11.0  # æŒ‡å®š Cura çš„ç‰ˆæœ¬å·
      VENV_DIR: ${{ github.workspace }}\.venv  # Python è™šæ‹Ÿç¯å¢ƒç›®å½•
      CONAN_USER_HOME: ${{ github.workspace }}\.conan  # Conan æœ¬åœ°ç¼“å­˜ç›®å½•

    steps:
    # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä½ å½“å‰ GitHub ä»“åº“çš„ä»£ç ï¼ˆå³ wsd07/Curaï¼‰
    - name: ğŸ§¾ æ£€å‡º Cura æºç 
      uses: actions/checkout@v3

    # ç¬¬äºŒæ­¥ï¼šå®‰è£… Python 3.12ï¼ˆConan 2.x éœ€è¦ Python â‰¥ 3.8ï¼Œæ¨èæœ€æ–°ç‰ˆï¼‰
    - name: ğŸ å®‰è£… Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    # ç¬¬ä¸‰æ­¥ï¼šå®‰è£… CMakeã€Ninjaã€NSISã€7zipã€Visual Studio æ„å»ºå·¥å…·ç­‰ä¾èµ–
    - name: ğŸ›  å®‰è£…æ„å»ºå·¥å…·
      run: |
        choco install cmake --version=3.27.0 -y  # å®‰è£… CMakeï¼Œç¡®ä¿ç‰ˆæœ¬ â‰¥3.23
        choco install ninja -y                  # å®‰è£… Ninjaï¼Œç”¨äºé«˜æ•ˆæ„å»º
        choco install nsis -y                   # å®‰è£… NSISï¼Œç”¨äºç”Ÿæˆå®‰è£…åŒ…
        choco install 7zip -y                   # å®‰è£… 7-Zipï¼Œæ‰“åŒ…æˆ–è§£å‹
        choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools" -y
        choco install windows-sdk-10.1 -y       # å®‰è£… Windows SDK è§£å†³ DLL ç¼ºå¤±é—®é¢˜
        # å°† NSIS æ·»åŠ åˆ° PATH
        $nsisPath = "${env:ProgramFiles(x86)}\NSIS"
        echo "NSISè·¯å¾„: $nsisPath"
        echo "$nsisPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    # ç¬¬å››æ­¥ï¼šåˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£… Python ä¾èµ–ï¼ŒåŒ…æ‹¬ Conan 2.xã€sip ç­‰
    - name: ğŸ§ª å®‰è£… Python ä¾èµ–
      run: |
        python -m venv $env:VENV_DIR  # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
        . "$env:VENV_DIR\Scripts\Activate.ps1"  # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
        python -m pip install --upgrade pip
        pip install sip==6.5.1  # å®‰è£…å®˜æ–¹è¦æ±‚ç‰ˆæœ¬çš„ sip
        pip install conan==2.7.0  # å®‰è£… Conan 2.xï¼ˆæ³¨æ„ä¸è¦ç”¨æ—§ç‰ˆï¼‰
        pip install gitpython
        conan config install https://github.com/wsd07/conan-config.git  # âœ… æ‹‰å–ä½ çš„å…±äº«é…ç½®
        conan profile detect --force  # âœ… è‡ªåŠ¨ç”Ÿæˆé»˜è®¤ profile

    # ç¬¬äº”æ­¥ï¼šå…‹éš† Uranium å’Œ CuraEngine ä»“åº“æºç 
    - name: ğŸ”ƒ å…‹éš† Uranium å’Œ CuraEngine
      run: |
        git clone https://github.com/wsd07/Uranium.git ../Uranium
        git clone https://github.com/wsd07/CuraEngine.git ../CuraEngine

    # ç¬¬å…­æ­¥ï¼šä½¿ç”¨ conan editable æ¨¡å¼æ³¨å†Œæœ¬åœ°æºç ï¼ˆæ–°ç‰ˆè¯­æ³•ï¼‰
    - name: ğŸ”— æ³¨å†Œ editable æºç ä¾èµ–ï¼ˆConan 2.x æ­£ç¡®è¯­æ³•ï¼‰
      run: |
        . $env:VENV_DIR\Scripts\activate.ps1
        conan editable add ../Uranium --name=uranium --version=5.11.0 --user=wsd07 --channel=testing
        conan editable add ../CuraEngine --name=curaengine --version=5.11.0 --user=wsd07 --channel=testing

    # ç¬¬ä¸ƒæ­¥ï¼šåˆ›å»ºæ„å»ºç›®å½•
    - name: ğŸ— åˆ›å»ºæ„å»ºç›®å½•
      run: mkdir build

    # ç¬¬å…«æ­¥ï¼šåˆ›å»º Cura åŒ…
    - name: ğŸ“¦ åˆ›å»º Cura åŒ…
      run: |
        . $env:VENV_DIR\Scripts\activate.ps1
        # ä½¿ç”¨ conan create åˆ›å»ºå®Œæ•´çš„åŒ…ï¼ˆåŒ…å« install, build, package æ­¥éª¤ï¼‰
        conan create . --build=missing -s build_type=Release -c tools.cmake.cmaketoolchain:generator=Ninja

    # ç¬¬ä¹æ­¥ï¼šä½¿ç”¨ conan install å’Œæ‰‹åŠ¨è°ƒç”¨ conanfile.py çš„åŠŸèƒ½
    - name: ğŸšš å‡†å¤‡ pyinstaller æ„å»ºç¯å¢ƒ
      run: |
        . $env:VENV_DIR\Scripts\activate.ps1

        # åˆ›å»º dist ç›®å½•
        mkdir -p dist

        # å®‰è£…ä¾èµ–åˆ°æœ¬åœ°ç¼“å­˜ï¼Œè¿™ä¼šè§¦å‘ conanfile.py ä¸­çš„å„ç§æ–¹æ³•
        conan install . -s build_type=Release

        # æ‰¾åˆ°åˆ›å»ºçš„åŒ…çš„ä½ç½®
        $package_ref = conan list "cura/*@wsd07/testing" --format=compact
        Write-Host "åŒ…å¼•ç”¨: $package_ref"

        # è·å–åŒ…çš„è·¯å¾„ä¿¡æ¯
        $package_info = conan list "cura/*@wsd07/testing" --format=json | ConvertFrom-Json
        Write-Host "åŒ…ä¿¡æ¯: $package_info"

        # æ‰‹åŠ¨å¤åˆ¶å¿…è¦çš„æ–‡ä»¶ï¼ˆæ¨¡æ‹Ÿ deploy() æ–¹æ³•çš„åŠŸèƒ½ï¼‰
        # å¤åˆ¶ cura_app.py åˆ° dist ç›®å½•
        Copy-Item "cura_app.py" "dist/" -Force

        # å¤åˆ¶èµ„æºæ–‡ä»¶
        Copy-Item "resources" "dist/" -Recurse -Force
        Copy-Item "plugins" "dist/" -Recurse -Force
        Copy-Item "cura" "dist/" -Recurse -Force
        Copy-Item "packaging" "dist/" -Recurse -Force

        # ä½¿ç”¨ conanfile.py ä¸­çš„ _generate_pyinstaller_spec æ–¹æ³•çš„é€»è¾‘åˆ›å»º spec æ–‡ä»¶
        # åˆ›å»ºç®€åŒ–ä½†åŠŸèƒ½å®Œæ•´çš„ PyInstaller spec æ–‡ä»¶
        echo '# -*- mode: python ; coding: utf-8 -*-' > dist/UltiMaker-Cura.spec
        echo 'block_cipher = None' >> dist/UltiMaker-Cura.spec
        echo 'a = Analysis([\"cura_app.py\"], pathex=[\"..\"], binaries=[], datas=[(\"resources\", \"share/cura/resources\"), (\"plugins\", \"share/cura/plugins\"), (\"packaging\", \"packaging\")], hiddenimports=[\"cura\", \"UM\", \"PyQt6\", \"PyQt6.QtCore\", \"PyQt6.QtWidgets\", \"PyQt6.QtQml\", \"PyQt6.QtQuick\", \"PyQt6.QtOpenGL\", \"PyQt6.QtNetwork\", \"PyQt6.QtSvg\", \"sip\", \"numpy\", \"scipy\", \"trimesh\", \"shapely\", \"cryptography\", \"keyring\", \"certifi\", \"requests\", \"urllib3\", \"charset_normalizer\", \"idna\"], hookspath=[], hooksconfig={}, runtime_hooks=[], excludes=[], win_no_prefer_redirects=False, win_private_assemblies=False, cipher=block_cipher, noarchive=False)' >> dist/UltiMaker-Cura.spec
        echo 'pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)' >> dist/UltiMaker-Cura.spec
        echo 'exe = EXE(pyz, a.scripts, [], exclude_binaries=True, name=\"UltiMaker-Cura\", debug=False, bootloader_ignore_signals=False, strip=False, upx=True, console=False, disable_windowed_traceback=False, argv_emulation=False, target_arch=None, codesign_identity=None, entitlements_file=None, icon=\"packaging/icons/Cura.ico\")' >> dist/UltiMaker-Cura.spec
        echo 'coll = COLLECT(exe, a.binaries, a.zipfiles, a.datas, strip=False, upx=True, upx_exclude=[], name=\"UltiMaker-Cura\")' >> dist/UltiMaker-Cura.spec

        # éªŒè¯æ–‡ä»¶ç»“æ„
        Write-Host "=== å‡†å¤‡çš„æ–‡ä»¶ç»“æ„ ==="
        Get-ChildItem -Recurse dist

        # æ£€æŸ¥ PyInstaller spec æ–‡ä»¶
        if (-not (Test-Path "dist/UltiMaker-Cura.spec")) {
            Write-Error "âŒ PyInstaller spec æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
        }
        Write-Host "âœ… PyInstaller æ„å»ºç¯å¢ƒå‡†å¤‡å®Œæˆ"

    # ç¬¬åæ­¥ï¼šå®‰è£… PyInstaller å¹¶æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
    - name: ğŸ”¨ ä½¿ç”¨ PyInstaller æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        . $env:VENV_DIR\Scripts\activate.ps1
        pip install pyinstaller==6.3.0

        # è®¾ç½® PYTHONPATH ä»¥åŒ…å«å½“å‰ç›®å½•å’Œ venv çš„ site-packages
        $env:PYTHONPATH = "$env:GITHUB_WORKSPACE;$env:VENV_DIR\Lib\site-packages"

        # åˆ‡æ¢åˆ°éƒ¨ç½²ç›®å½•å¹¶è¿è¡Œ pyinstallerï¼ˆä½¿ç”¨å‡†å¤‡å¥½çš„ spec æ–‡ä»¶ï¼‰
        cd dist
        pyinstaller UltiMaker-Cura.spec --clean --noconfirm --log-level=INFO

        # éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶ç”Ÿæˆ
        if (-not (Test-Path "dist/UltiMaker-Cura/UltiMaker-Cura.exe")) {
            Write-Error "âŒ PyInstaller æœªç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶"
            Write-Host "PyInstaller è¾“å‡ºç›®å½•å†…å®¹ï¼š"
            Get-ChildItem -Recurse
            exit 1
        }

        $exe_size = (Get-Item "dist/UltiMaker-Cura/UltiMaker-Cura.exe").Length/1MB
        Write-Host "âœ… å¯æ‰§è¡Œæ–‡ä»¶ç”ŸæˆæˆåŠŸ (å¤§å°: $exe_size MB)"

    # ç¬¬åä¸€æ­¥ï¼šè°ƒç”¨ NSIS è„šæœ¬æ‰“åŒ…æˆå®‰è£…åŒ…
    - name: ğŸ“¦ æ‰“åŒ…æˆå®‰è£…ç¨‹åº
      run: |
        . $env:VENV_DIR\Scripts\activate.ps1
        pip install jinja2 semver
        
        $nsis_script = "$env:GITHUB_WORKSPACE/packaging/NSIS/create_windows_installer.py"
        if (-not (Test-Path $nsis_script)) {
            Write-Error "âŒ NSISè„šæœ¬æœªæ‰¾åˆ°: $nsis_script"
            Get-ChildItem -Recurse -Name "*create_windows_installer.py" | ForEach-Object { Write-Host "æ‰¾åˆ°: $_" }
            exit 1
        }
        
        python $nsis_script --source_path "$env:GITHUB_WORKSPACE" --dist_path "$env:GITHUB_WORKSPACE/dist/dist/UltiMaker-Cura" --filename "UltiMaker-Cura-$env:CURA_VERSION-Windows-x64.exe" --version $env:CURA_VERSION
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "å°è¯•ä½¿ç”¨å¤‡ç”¨è·¯å¾„..."
            python $nsis_script --source_path "$env:GITHUB_WORKSPACE" --dist_path "$env:GITHUB_WORKSPACE/dist/UltiMaker-Cura" --filename "UltiMaker-Cura-$env:CURA_VERSION-Windows-x64.exe" --version $env:CURA_VERSION
        }
        
        $installer_path = "UltiMaker-Cura-$env:CURA_VERSION-Windows-x64.exe"
        if (-not (Test-Path $installer_path)) {
            Write-Error "âŒ å®‰è£…åŒ…æœªç”Ÿæˆ: $installer_path"
            Get-ChildItem -Name
            exit 1
        }
        $size = (Get-Item $installer_path).Length/1MB
        Write-Host "âœ… å®‰è£…åŒ…ç”ŸæˆæˆåŠŸ (å¤§å°: $size MB)"
        
        Move-Item $installer_path "$env:GITHUB_WORKSPACE/dist/"

    # ç¬¬åäºŒæ­¥ï¼šä¸Šä¼ æ„å»ºäº§ç‰©
    - name: â˜ï¸ ä¸Šä¼ å®‰è£…åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: cura-windows-installer
        path: dist/UltiMaker-Cura-${{ env.CURA_VERSION }}-Windows-x64.exe
