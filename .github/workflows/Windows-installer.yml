# åç§°ï¼šåœ¨ GitHub Actions é¡µé¢æ˜¾ç¤ºçš„ä»»åŠ¡åç§°
name: Build and Package Cura Installer (Windows)

# è§¦å‘æ–¹å¼ï¼šæ‰‹åŠ¨è§¦å‘ workflowï¼ˆå¯é€‰ future æ‰©å±• push/tag ç­‰è§¦å‘ï¼‰
on:
  workflow_dispatch:

jobs:
  build-windows:
    # æŒ‡å®šè¿è¡Œå¹³å°ä¸º GitHub æä¾›çš„æœ€æ–° Windows ç³»ç»Ÿï¼ˆWindows Server 2022ï¼‰
    runs-on: windows-latest

    # è®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡
    env:
      CURA_VERSION: 5.11.0  # æŒ‡å®š Cura çš„ç‰ˆæœ¬å·
      VENV_DIR: ${{ github.workspace }}\.venv  # Python è™šæ‹Ÿç¯å¢ƒç›®å½•
      CONAN_USER_HOME: ${{ github.workspace }}\.conan  # Conan æœ¬åœ°ç¼“å­˜ç›®å½•

    steps:
    # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä½ å½“å‰ GitHub ä»“åº“çš„ä»£ç ï¼ˆå³ wsd07/Curaï¼‰
    - name: ğŸ§¾ æ£€å‡º Cura æºç 
      uses: actions/checkout@v3

    # ç¬¬äºŒæ­¥ï¼šå®‰è£… Python 3.12ï¼ˆConan 2.x éœ€è¦ Python â‰¥ 3.8ï¼Œæ¨èæœ€æ–°ç‰ˆï¼‰
    - name: ğŸ å®‰è£… Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    # ç¬¬ä¸‰æ­¥ï¼šå®‰è£… CMakeã€Ninjaã€NSISã€7zipã€Visual Studio æ„å»ºå·¥å…·ç­‰ä¾èµ–
    - name: ğŸ›  å®‰è£…æ„å»ºå·¥å…·
      run: |
        choco install cmake --version=3.27.0 -y  # å®‰è£… CMakeï¼Œç¡®ä¿ç‰ˆæœ¬ â‰¥3.23
        choco install ninja -y                  # å®‰è£… Ninjaï¼Œç”¨äºé«˜æ•ˆæ„å»º
        choco install nsis -y                   # å®‰è£… NSISï¼Œç”¨äºç”Ÿæˆå®‰è£…åŒ…
        choco install 7zip -y                   # å®‰è£… 7-Zipï¼Œæ‰“åŒ…æˆ–è§£å‹
        choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools" -y
        # å®‰è£… Visual Studio 2022 çš„ C++ å·¥å…·é“¾

    # ç¬¬å››æ­¥ï¼šåˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£… Python ä¾èµ–ï¼ŒåŒ…æ‹¬ Conan 2.xã€sip ç­‰
    - name: ğŸ§ª å®‰è£… Python ä¾èµ–
      run: |
        python -m venv $env:VENV_DIR  # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
        . "$env:VENV_DIR\Scripts\Activate.ps1"  # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
        python -m pip install --upgrade pip
        pip install sip==6.5.1  # å®‰è£…å®˜æ–¹è¦æ±‚ç‰ˆæœ¬çš„ sip
        pip install conan==2.7.0  # å®‰è£… Conan 2.xï¼ˆæ³¨æ„ä¸è¦ç”¨æ—§ç‰ˆï¼‰

    # ç¬¬äº”æ­¥ï¼šå…‹éš† Uranium å’Œ CuraEngine ä»“åº“æºç 
    - name: ğŸ”ƒ å…‹éš† Uranium å’Œ CuraEngine
      run: |
        git clone https://github.com/wsd07/Uranium.git ../Uranium
        git clone https://github.com/wsd07/CuraEngine.git ../CuraEngine

    # ç¬¬å…­æ­¥ï¼šä½¿ç”¨ conan editable æ¨¡å¼æ³¨å†Œæœ¬åœ°æºç ï¼ˆæ–°ç‰ˆè¯­æ³•ï¼‰
    - name: ğŸ”— æ³¨å†Œ editable æºç ä¾èµ–ï¼ˆConan 2.x æ­£ç¡®è¯­æ³•ï¼‰
      run: |
        conan editable add ../Uranium --name=uranium --version=5.11.0 --user=wsd07
        conan editable add ../CuraEngine --name=curaengine --version=5.11.0 --user=wsd07

    # ç¬¬ä¸ƒæ­¥ï¼šåˆ›å»ºæ„å»ºç›®å½•
    - name: ğŸ— åˆ›å»ºæ„å»ºç›®å½•
      run: mkdir build

    # ç¬¬å…«æ­¥ï¼šè¿è¡Œ conan install å®‰è£…æ‰€æœ‰ä¾èµ–ï¼Œå¹¶ç”Ÿæˆæ„å»ºé…ç½®
    - name: ğŸ“¦ Conan å®‰è£…ä¾èµ–ï¼ˆå¹¶ç”Ÿæˆ toolchainï¼‰
      working-directory: build
      run: |
        . $env:VENV_DIR\Scripts\activate.ps1
        conan install .. --build=missing -s build_type=Release -c tools.cmake.cmaketoolchain:generator=Ninja

    # ç¬¬ä¹æ­¥ï¼šæ‰§è¡Œ conan build ç¼–è¯‘ Curaï¼ˆè°ƒç”¨ conanfile.py ä¸­çš„ build å‡½æ•°ï¼‰
    - name: ğŸ”¨ æ„å»º Cura é¡¹ç›®
      working-directory: build
      run: |
        . $env:VENV_DIR\Scripts\activate.ps1
        conan build ..

    # ç¬¬åæ­¥ï¼šè°ƒç”¨ NSIS è„šæœ¬æ‰“åŒ…æˆ .exe å®‰è£…åŒ…
    - name: ğŸ“¦ æ‰“åŒ…æˆå®‰è£…ç¨‹åºï¼ˆä½¿ç”¨ NSISï¼‰
      working-directory: packaging/NSIS
      run: |
        makensis.exe /DVERSION=${{ env.CURA_VERSION }} CuraInstaller.nsi

    # ç¬¬åä¸€æ­¥ï¼šä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆ.exe å®‰è£…åŒ…ï¼‰ä½œä¸º GitHub Artifacts
    - name: â˜ï¸ ä¸Šä¼ å®‰è£…åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: cura-windows-installer
        path: packaging/NSIS/Cura*.exe